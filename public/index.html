<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notion2Obsidian - プロパティ設定</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 12px;
      background: #f5f5f5;
      font-size: 13px;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #4a9eff;
      padding-bottom: 6px;
      font-size: 1.3em;
      margin: 0 0 12px 0;
    }
    .db-selector {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .db-selector label {
      font-weight: 500;
      color: #555;
    }
    .db-selector select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      background: white;
      cursor: pointer;
      flex: 1;
    }
    .db-selector select:focus {
      outline: none;
      border-color: #4a9eff;
    }
    .section {
      background: white;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section h2 {
      margin-top: 0;
      margin-bottom: 6px;
      color: #555;
      font-size: 0.95em;
    }
    .property-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .property-item {
      display: flex;
      align-items: center;
      padding: 6px 8px;
      margin: 4px 0;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: grab;
      transition: all 0.2s;
      font-size: 12px;
    }
    .property-item:hover {
      background: #f0f0f0;
      border-color: #4a9eff;
    }
    .property-item.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    .property-item.drag-over {
      border-color: #4a9eff;
      background: #e8f4ff;
    }
    .property-item.custom {
      background: #fff9e6;
      border-color: #ffc107;
    }
    .property-item.custom:hover {
      background: #fff3cd;
      border-color: #e0a800;
    }
    .property-item input[type="checkbox"] {
      width: 14px;
      height: 14px;
      margin-right: 8px;
      cursor: pointer;
    }
    .property-item .drag-handle {
      margin-right: 8px;
      color: #999;
      cursor: grab;
      font-size: 11px;
    }
    .property-item .name {
      font-weight: 500;
      min-width: 80px;
    }
    .property-item .arrow {
      color: #999;
      margin: 0 6px;
      font-size: 10px;
    }
    .property-item .output-name {
      flex: 1;
      padding: 2px 6px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 11px;
      min-width: 80px;
      max-width: 120px;
    }
    .property-item .output-name:focus {
      outline: none;
      border-color: #4a9eff;
    }
    .property-item .output-name::placeholder {
      color: #bbb;
    }
    .property-item .plus {
      color: #28a745;
      margin: 0 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .property-item .addition-value {
      padding: 2px 6px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 11px;
      min-width: 60px;
      max-width: 100px;
    }
    .property-item .addition-value:focus {
      outline: none;
      border-color: #28a745;
    }
    .property-item .addition-value::placeholder {
      color: #bbb;
    }
    .property-item .value {
      color: #666;
      font-size: 0.85em;
      margin-right: 8px;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .property-item .type {
      color: #888;
      font-size: 0.8em;
      background: #eee;
      padding: 1px 6px;
      border-radius: 3px;
    }
    .property-item .type.custom-type {
      background: #fff3cd;
      color: #856404;
    }
    .property-item .delete-btn {
      margin-left: 6px;
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      font-size: 1em;
      padding: 0 4px;
    }
    .property-item .delete-btn:hover {
      color: #a71d2a;
    }
    .add-custom-form {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .add-custom-form input {
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }
    .add-custom-form input[name="name"] {
      width: 120px;
    }
    .add-custom-form input[name="value"] {
      flex: 1;
      min-width: 150px;
    }
    .add-custom-form button {
      padding: 6px 12px;
    }
    .buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    button.primary {
      background: #4a9eff;
      color: white;
    }
    button.primary:hover {
      background: #3a8eef;
    }
    button.secondary {
      background: #ddd;
      color: #333;
    }
    button.secondary:hover {
      background: #ccc;
    }
    button.add {
      background: #28a745;
      color: white;
    }
    button.add:hover {
      background: #218838;
    }
    .status {
      padding: 8px;
      border-radius: 4px;
      margin-top: 8px;
      display: none;
      font-size: 12px;
    }
    .status.success {
      display: block;
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      display: block;
      background: #f8d7da;
      color: #721c24;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .hint {
      color: #888;
      font-size: 0.85em;
      margin-bottom: 8px;
    }
    .value-hint {
      color: #888;
      font-size: 0.8em;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>Notion2Obsidian - プロパティ設定</h1>

  <div class="db-selector">
    <label for="db-select">データベース:</label>
    <select id="db-select" onchange="onDatabaseChange()">
      <option value="">読み込み中...</option>
    </select>
  </div>

  <div class="section">
    <h2>出力するプロパティの選択と順序</h2>
    <p class="hint">ドラッグ&ドロップで順番を変更、出力名や追加値を編集できます。チェックを外すと出力されません。</p>
    <div id="property-container">
      <div class="loading">データベースを選択してください</div>
    </div>
  </div>

  <div class="section">
    <h2>カスタムプロパティの追加</h2>
    <p class="hint">Notionにはないオリジナルのプロパティを追加できます。</p>
    <div class="add-custom-form">
      <input type="text" name="name" placeholder="プロパティ名" id="custom-name">
      <input type="text" name="value" placeholder="値（空でもOK）" id="custom-value">
      <button class="add" onclick="addCustomProperty()">追加</button>
    </div>
    <p class="value-hint">配列にする場合はカンマ区切りで入力（例: tag1, tag2, tag3）</p>
  </div>

  <div class="buttons">
    <button class="primary" onclick="saveConfig()">設定を保存</button>
    <button class="secondary" onclick="resetConfig()">リセット</button>
  </div>

  <div id="status" class="status"></div>

  <script>
    let databases = [];
    let selectedDatabase = null;
    let properties = [];
    let customProperties = [];
    let originalProperties = [];
    let originalCustomProperties = [];

    // データベース一覧を取得
    async function loadDatabases() {
      try {
        const response = await fetch('/api/databases');
        const data = await response.json();

        if (data.error) {
          showStatus('error', data.error);
          return;
        }

        databases = data.databases;
        renderDatabaseSelector();

        // データベースが1つしかない場合は自動選択
        if (databases.length === 1) {
          document.getElementById('db-select').value = databases[0].name;
          onDatabaseChange();
        }
      } catch (error) {
        showStatus('error', 'データベースの読み込みに失敗しました: ' + error.message);
      }
    }

    // データベースセレクターを描画
    function renderDatabaseSelector() {
      const select = document.getElementById('db-select');
      select.innerHTML = databases.map(db =>
        `<option value="${db.name}">${db.name}</option>`
      ).join('');

      if (databases.length === 0) {
        select.innerHTML = '<option value="">データベースがありません</option>';
      }
    }

    // データベース変更時の処理
    function onDatabaseChange() {
      const select = document.getElementById('db-select');
      selectedDatabase = select.value;

      if (selectedDatabase) {
        loadProperties();
      } else {
        document.getElementById('property-container').innerHTML =
          '<div class="loading">データベースを選択してください</div>';
      }
    }

    // プロパティ一覧を取得
    async function loadProperties() {
      if (!selectedDatabase) return;

      document.getElementById('property-container').innerHTML =
        '<div class="loading">プロパティを読み込み中...</div>';

      try {
        const response = await fetch(`/api/properties?db=${encodeURIComponent(selectedDatabase)}`);
        const data = await response.json();

        if (data.error) {
          showStatus('error', data.error);
          document.getElementById('property-container').innerHTML =
            `<div class="loading">${data.error}</div>`;
          return;
        }

        properties = data.properties;
        customProperties = data.customProperties || [];
        originalProperties = JSON.parse(JSON.stringify(properties));
        originalCustomProperties = JSON.parse(JSON.stringify(customProperties));
        renderProperties();
      } catch (error) {
        showStatus('error', 'プロパティの読み込みに失敗しました: ' + error.message);
      }
    }

    // 値を表示用にフォーマット
    function formatValue(value) {
      if (value === '' || value === null || value === undefined) {
        return '(空)';
      }
      if (Array.isArray(value)) {
        return value.join(', ');
      }
      return String(value);
    }

    // プロパティ一覧を描画
    function renderProperties() {
      const container = document.getElementById('property-container');

      // Notionプロパティとカスタムプロパティを結合
      const allItems = [
        ...properties.map((prop, index) => ({
          ...prop,
          isCustom: false,
          originalIndex: index
        })),
        ...customProperties.map((prop, index) => ({
          name: prop.name,
          type: 'custom',
          enabled: true,
          value: prop.value,
          isCustom: true,
          originalIndex: index
        }))
      ];

      const html = `
        <ul class="property-list" id="property-list">
          ${allItems.map((prop, index) => `
            <li class="property-item ${prop.isCustom ? 'custom' : ''}" draggable="true" data-index="${index}" data-is-custom="${prop.isCustom}" data-original-index="${prop.originalIndex}">
              <span class="drag-handle">☰</span>
              ${prop.isCustom ? '' : `<input type="checkbox" ${prop.enabled ? 'checked' : ''} onchange="toggleProperty(${prop.originalIndex})">`}
              <span class="name">${prop.name}</span>
              ${prop.isCustom ? '' : `<span class="arrow">→</span><input type="text" class="output-name" value="${prop.outputName || ''}" placeholder="${prop.name}" onchange="updateOutputName(${prop.originalIndex}, this.value)"><span class="plus">+</span><input type="text" class="addition-value" value="${prop.additionValue || ''}" placeholder="追加値" onchange="updateAdditionValue(${prop.originalIndex}, this.value)">`}
              ${prop.isCustom ? `<span class="value">${formatValue(prop.value)}</span>` : ''}
              <span class="type ${prop.isCustom ? 'custom-type' : ''}">${prop.isCustom ? 'カスタム' : prop.type}</span>
              ${prop.isCustom ? `<button class="delete-btn" onclick="deleteCustomProperty(${prop.originalIndex})">×</button>` : ''}
            </li>
          `).join('')}
        </ul>
      `;

      container.innerHTML = html;
      setupDragAndDrop();
    }

    // ドラッグ&ドロップの設定
    function setupDragAndDrop() {
      const list = document.getElementById('property-list');
      const items = list.querySelectorAll('.property-item');

      let draggedItem = null;

      items.forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedItem = item;
          item.classList.add('dragging');
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
          items.forEach(i => i.classList.remove('drag-over'));
          draggedItem = null;
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (item !== draggedItem) {
            item.classList.add('drag-over');
          }
        });

        item.addEventListener('dragleave', () => {
          item.classList.remove('drag-over');
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          item.classList.remove('drag-over');

          if (draggedItem && item !== draggedItem) {
            // 現在の表示順を取得して並び替え
            const listItems = Array.from(list.querySelectorAll('.property-item'));
            const fromIndex = listItems.indexOf(draggedItem);
            const toIndex = listItems.indexOf(item);

            // 結合した配列を作成
            const allItems = [
              ...properties.map((prop, index) => ({
                ...prop,
                outputName: prop.outputName || '',
                additionValue: prop.additionValue || '',
                isCustom: false,
                originalIndex: index
              })),
              ...customProperties.map((prop, index) => ({
                name: prop.name,
                value: prop.value,
                isCustom: true,
                originalIndex: index
              }))
            ];

            // 順序を変更
            const [moved] = allItems.splice(fromIndex, 1);
            allItems.splice(toIndex, 0, moved);

            // 分離して元の配列に戻す
            properties = allItems
              .filter(item => !item.isCustom)
              .map(item => ({
                name: item.name,
                type: item.type,
                enabled: item.enabled,
                outputName: item.outputName || '',
                additionValue: item.additionValue || ''
              }));

            customProperties = allItems
              .filter(item => item.isCustom)
              .map(item => ({
                name: item.name,
                value: item.value
              }));

            renderProperties();
          }
        });
      });
    }

    // プロパティの有効/無効を切り替え
    function toggleProperty(originalIndex) {
      properties[originalIndex].enabled = !properties[originalIndex].enabled;
    }

    // 出力名を更新
    function updateOutputName(originalIndex, value) {
      properties[originalIndex].outputName = value;
    }

    // 追加値を更新
    function updateAdditionValue(originalIndex, value) {
      properties[originalIndex].additionValue = value;
    }

    // カスタムプロパティを追加
    function addCustomProperty() {
      const nameInput = document.getElementById('custom-name');
      const valueInput = document.getElementById('custom-value');

      const name = nameInput.value.trim();
      const valueStr = valueInput.value.trim();

      if (!name) {
        showStatus('error', 'プロパティ名を入力してください');
        return;
      }

      // 同名のプロパティが存在するかチェック
      const existsInNotion = properties.some(p => p.name === name);
      const existsInCustom = customProperties.some(p => p.name === name);

      if (existsInNotion || existsInCustom) {
        showStatus('error', '同じ名前のプロパティが既に存在します');
        return;
      }

      // 値をパース（カンマ区切りは配列に）
      let value;
      if (valueStr === '') {
        value = '';
      } else if (valueStr.includes(',')) {
        value = valueStr.split(',').map(v => v.trim()).filter(v => v);
      } else if (valueStr === 'true') {
        value = true;
      } else if (valueStr === 'false') {
        value = false;
      } else if (!isNaN(Number(valueStr)) && valueStr !== '') {
        value = Number(valueStr);
      } else {
        value = valueStr;
      }

      customProperties.push({ name, value });
      renderProperties();

      // 入力欄をクリア
      nameInput.value = '';
      valueInput.value = '';

      showStatus('success', `カスタムプロパティ「${name}」を追加しました`);
    }

    // カスタムプロパティを削除
    function deleteCustomProperty(index) {
      const name = customProperties[index].name;
      customProperties.splice(index, 1);
      renderProperties();
      showStatus('success', `カスタムプロパティ「${name}」を削除しました`);
    }

    // 設定を保存
    async function saveConfig() {
      if (!selectedDatabase) {
        showStatus('error', 'データベースを選択してください');
        return;
      }

      try {
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dbName: selectedDatabase, properties, customProperties })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('success', '設定を保存しました');
          originalProperties = JSON.parse(JSON.stringify(properties));
          originalCustomProperties = JSON.parse(JSON.stringify(customProperties));
        } else {
          showStatus('error', '保存に失敗しました: ' + data.error);
        }
      } catch (error) {
        showStatus('error', '保存に失敗しました: ' + error.message);
      }
    }

    // リセット
    function resetConfig() {
      properties = JSON.parse(JSON.stringify(originalProperties));
      customProperties = JSON.parse(JSON.stringify(originalCustomProperties));
      renderProperties();
      showStatus('success', '設定をリセットしました');
    }

    // ステータス表示
    function showStatus(type, message) {
      const status = document.getElementById('status');
      status.className = 'status ' + type;
      status.textContent = message;

      setTimeout(() => {
        status.className = 'status';
      }, 3000);
    }

    // Enterキーで追加
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.target.id === 'custom-name' || e.target.id === 'custom-value')) {
        addCustomProperty();
      }
    });

    // 初期化
    loadDatabases();
  </script>
</body>
</html>
